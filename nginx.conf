upstream gunicorn_djnci {
    server unix:/tmp/gunicorn_djnci.sock fail_timeout=0;
}

server {
    listen 443 default ssl;
    server_name discovernci.org;
    # add_header X-Frame-Options SAMEORIGIN; # already defined in OEM system config?
    root /home/ubuntu/discovernci.org/frontend/live/;
    access_log /var/log/nginx/discovernci.org_access.log;
    error_log /var/log/nginx/discovernci.org_error.log notice;
    keepalive_timeout 3;
    autoindex off;
    index index.html;

    gzip_comp_level 6;
    gzip_http_version 1.0;
    gzip_proxied off;
    gzip_types
      text/plain
      text/css
      text/javascript
      application/x-javascript
      application/javascript
      application/json
      text/xml
      application/xml
      application/xml+rss
      font/ttf
      font/truetype
      font/opentype
      application/vnd.ms-fontobject
      image/bmp
      image/png
      image/gif
      image/jpeg
      image/jpg
      image/svg+xml;

    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';

    # Diffie-Hellman Encryption - "ephemeral Diffie-Hellman"
    # https://www.quora.com/How-would-you-explain-the-Diffie-Hellman-as-applied-in-SSL
    # https://security.stackexchange.com/a/41226/175445
    ssl_dhparam /home/ubuntu/discovernci.org/dhparams.pem;

    ssl_certificate     /etc/letsencrypt/live/discovernci.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/discovernci.org/privkey.pem;

    # Static media. CSS, JavaScript, UI images.
    location ^~ /static {
        alias /home/ubuntu/discovernci.org/static_collected/;
    }

    # Media. Images, PDF, uploaded by users via admin panel or api...
    location ^~ /media {
        alias /home/ubuntu/discovernci.org/media/;
    }

    # location @django {
    #     client_max_body_size       10m;
    #     client_body_buffer_size    128k;
    #     proxy_buffering off;
    #     proxy_redirect off;
    #     proxy_set_header Host $http_host;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Ssl  on;
    #     proxy_pass http://gunicorn_djnci;
    # }

    # location / {
    #     try_files $uri $uri/index.html $uri.html @django;
    # }

    location / {
        client_max_body_size    10m;
        client_body_buffer_size 128k;
        proxy_buffering         off;
        proxy_redirect          off;
        proxy_set_header        Host $http_host;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Ssl on;
        if (!-f $request_filename) {
            proxy_pass http://gunicorn_djnci;
            break;
        }
        try_files try_files $uri $uri/ index.html;
    }
}

# HTTP to HTTPS Rewrites ******************************************************

server {
    listen 80;
    server_name nciw.org www.nciw.org skyview.nciw.org discovernci.org www.discovernci.org;
    rewrite ^(.*) https://discovernci.org$1 permanent;
    access_log off;
}

# Vanity domains **************************************************************

server {
    listen 80;
    server_name dinnerinthewoods.org www.dinnerinthewoods.org;
    rewrite ^(.*) https://discovernci.org/events/dinner-in-the-woods$1 permanent;
    access_log off;
}

server {
    listen 80;
    server_name rosegardenevent.org www.rosegardenevent.org;
    rewrite ^/$ https://discovernci.org/ permanent;
    access_log off;
}
